name: Build OpenClash Configs

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'templates/**'
      - '.github/workflows/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install PyYAML Jinja2

      - name: Sync upstream configs
        run: |
          set -e
          git clone --depth=1 https://github.com/HenryChiao/mihomo_yamls.git upstream

          mkdir -p raw_configs
          cp upstream/General_Config/*.yaml raw_configs/ 2>/dev/null || true
          cp upstream/Smart_Mode/*.yaml raw_configs/ 2>/dev/null || true

          echo "ðŸ“¦ Found $(ls raw_configs/*.yaml 2>/dev/null | wc -l) YAML files"

      - name: Strip YAML configs
        run: |
          set -e
          python src/yaml_stripper.py raw_configs processed_configs --verbose
          echo "âœ… Stripped $(ls processed_configs/*.yaml 2>/dev/null | wc -l) configs"

      - name: Generate .conf files
        run: |
          set -e
          python src/conf_generator.py \
            processed_configs \
            output \
            --templates templates \
            --types main_router bypass_router smart \
            --verbose

          echo "âœ… Generated $(ls output/*.conf 2>/dev/null | wc -l) .conf files"

      - name: Generate README for configs
        run: |
          set -e
          cat > output/README.md << 'EOF'
          # OpenClash è¦†å†™é…ç½®æ–‡ä»¶

          è‡ªåŠ¨ç”ŸæˆäºŽ: $(date +'%Y-%m-%d %H:%M:%S UTC')

          ## ðŸ“‹ é…ç½®æ–‡ä»¶åˆ—è¡¨
          EOF

          for conf in output/*.conf; do
            filename=$(basename "$conf")
            echo "- [$filename]($filename)" >> output/README.md
          done

          cat >> output/README.md << 'EOF'

          ## ðŸš€ ä½¿ç”¨æ–¹æ³•

          ### 1. æ·»åŠ è¦†å†™æ¨¡å—
          åœ¨ OpenClash ä¸­æ·»åŠ è¦†å†™æ¨¡å—ï¼Œä½¿ç”¨ä»¥ä¸‹æ ¼å¼çš„ URL:

          ```
          https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/output/æ–‡ä»¶å.conf
          ```

          ### 2. é…ç½®çŽ¯å¢ƒå˜é‡
          - å•è®¢é˜…: EN_KEY=æœºåœºè®¢é˜…é“¾æŽ¥
          - å¤šè®¢é˜…: EN_KEY1=è®¢é˜…1;EN_KEY2=è®¢é˜…2;...
          - æ—è·¯ç”±: é¢å¤–éœ€è¦ EN_DNS=DNSæœåŠ¡å™¨åœ°å€

          ### 3. åº”ç”¨é…ç½®
          ä¿å­˜å¹¶é‡å¯ OpenClashã€‚

          ## ðŸ“ é…ç½®ç±»åž‹è¯´æ˜Ž
          | åŽç¼€ | è¯´æ˜Ž |
          |------|------|
          | (æ— ) | ä¸»è·¯ç”±æ ‡å‡†é…ç½® |
          | -bypass_router | æ—è·¯ç”±é…ç½® |
          | -smart | Smart æ™ºèƒ½æ¨¡å¼ |

          ## âš ï¸ æ³¨æ„äº‹é¡¹
          1. æ‰€æœ‰é…ç½®ä¼šè‡ªåŠ¨ä¸‹è½½å¯¹åº”çš„ç²¾ç®€ YAML
          2. ç²¾ç®€åŽçš„ YAML åªåŒ…å« providers ä¸Ž rules
          3. æ ¹æ® provider æ•°é‡è‡ªåŠ¨ç”ŸæˆçŽ¯å¢ƒå˜é‡è¦æ±‚

          EOF

      - name: Generate file checksums
        run: |
          set -e
          cd output
          if ls *.conf >/dev/null 2>&1; then
            sha256sum *.conf > SHA256SUMS
          else
            echo "No .conf files found" > SHA256SUMS
          fi
          cd ..

      - name: Debug SHA256SUMS
        run: |
          ls -l output/SHA256SUMS
          cat output/SHA256SUMS

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create/Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.date.outputs.date }}
          name: Release ${{ steps.date.outputs.date }}
          body: |
            ## ðŸ“¦ OpenClash è¦†å†™é…ç½®æ–‡ä»¶
            **ç”Ÿæˆæ—¶é—´**: ${{ steps.date.outputs.date }}

            ### ðŸ“ åŒ…å«å†…å®¹
            - ç²¾ç®€åŽçš„ YAML (`processed_configs/`)
            - OpenClash è¦†å†™æ–‡ä»¶ (`output/`)
            - SHA256SUMS æ ¡éªŒæ–‡ä»¶

            ### ðŸ“Š ç»Ÿè®¡
            - YAML æ•°é‡: $(ls processed_configs/*.yaml 2>/dev/null | wc -l)
            - .conf æ•°é‡: $(ls output/*.conf 2>/dev/null | wc -l)

          files: |
            output/*.conf
            output/SHA256SUMS
            output/README.md

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit changes
        run: |
          set -e
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add processed_configs/ output/
          git commit -m "ðŸ¤– Auto-build: ${{ steps.date.outputs.date }}" || echo "No changes to commit"
          git push
