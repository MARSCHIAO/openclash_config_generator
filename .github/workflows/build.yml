name: Build OpenClash Configs

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹ (UTC) è‡ªåŠ¨è¿è¡Œ
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    # æ‰‹åŠ¨è§¦å‘
  
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'templates/**'
      - '.github/workflows/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML Jinja2
      
      - name: Sync upstream configs
        run: |
          # å…‹éš†ä¸Šæ¸¸ä»“åº“
          git clone --depth=1 https://github.com/HenryChiao/mihomo_yamls.git upstream
          
          # å¤åˆ¶ YAML é…ç½®æ–‡ä»¶
          mkdir -p raw_configs
          cp upstream/General_Config/*.yaml raw_configs/ 2>/dev/null || true
          cp upstream/Smart_Mode/*.yaml raw_configs/ 2>/dev/null || true
          
          echo "ðŸ“¦ Found $(ls raw_configs/*.yaml 2>/dev/null | wc -l) YAML files"
      
      - name: Strip YAML configs
        run: |
          # ç²¾ç®€ YAML æ–‡ä»¶
          python src/yaml_stripper.py raw_configs processed_configs --verbose
          
          echo "âœ… Stripped $(ls processed_configs/*.yaml 2>/dev/null | wc -l) configs"
      
      - name: Generate .conf files
        run: |
          # ç”Ÿæˆ .conf é…ç½®æ–‡ä»¶
          python src/conf_generator.py \
            processed_configs \
            output \
            --templates templates \
            --types main_router bypass_router smart \
            --verbose
          
          echo "âœ… Generated $(ls output/*.conf 2>/dev/null | wc -l) .conf files"
      
      - name: Generate README for configs
        run: |
          cat > output/README.md << 'EOF'
          # OpenClash è¦†å†™é…ç½®æ–‡ä»¶
          
          è‡ªåŠ¨ç”ŸæˆäºŽ: $(date +'%Y-%m-%d %H:%M:%S UTC')
          
          ## ðŸ“‹ é…ç½®æ–‡ä»¶åˆ—è¡¨
          
          EOF
          
          # åˆ—å‡ºæ‰€æœ‰ .conf æ–‡ä»¶
          for conf in output/*.conf; do
            filename=$(basename "$conf")
            echo "- [$filename]($filename)" >> output/README.md
          done
          
          cat >> output/README.md << 'EOF'
          
          ## ðŸš€ ä½¿ç”¨æ–¹æ³•
          
          ### 1. æ·»åŠ è¦†å†™æ¨¡å—
          
          åœ¨ OpenClash ä¸­æ·»åŠ è¦†å†™æ¨¡å—ï¼Œä½¿ç”¨ä»¥ä¸‹æ ¼å¼çš„ URL:
          
          ```
          https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/output/æ–‡ä»¶å.conf
          ```
          
          ### 2. é…ç½®çŽ¯å¢ƒå˜é‡
          
          æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„æç¤ºè®¾ç½®çŽ¯å¢ƒå˜é‡ï¼š
          
          - **å•è®¢é˜…é…ç½®**: `EN_KEY=æœºåœºè®¢é˜…é“¾æŽ¥`
          - **å¤šè®¢é˜…é…ç½®**: `EN_KEY1=è®¢é˜…1;EN_KEY2=è®¢é˜…2;...`
          - **æ—è·¯ç”±é…ç½®**: é¢å¤–éœ€è¦ `EN_DNS=DNSæœåŠ¡å™¨åœ°å€`
          
          ### 3. åº”ç”¨é…ç½®
          
          ä¿å­˜å¹¶é‡å¯ OpenClashã€‚
          
          ## ðŸ“ é…ç½®ç±»åž‹è¯´æ˜Ž
          
          | åŽç¼€ | è¯´æ˜Ž |
          |------|------|
          | (æ— ) | ä¸»è·¯ç”±æ ‡å‡†é…ç½® |
          | `-bypass_router` | æ—è·¯ç”±é…ç½® |
          | `-smart` | Smart æ™ºèƒ½æ¨¡å¼ |
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          
          1. æ‰€æœ‰é…ç½®éƒ½ä¼šè‡ªåŠ¨ä¸‹è½½å¯¹åº”çš„ç²¾ç®€ YAML æ–‡ä»¶åˆ°è·¯ç”±å™¨
          2. ç²¾ç®€åŽçš„ YAML åªåŒ…å« proxy-providers, proxy-groups, rule-providers, rules
          3. æ ¹æ® provider æ•°é‡è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„çŽ¯å¢ƒå˜é‡è¦æ±‚
          
          EOF
      
      - name: Generate file checksums
        run: |
          cd output
          sha256sum *.conf > SHA256SUMS 2>/dev/null || echo "No .conf files"
          cd ..
      
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Create/Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.date.outputs.date }}
          name: Release ${{ steps.date.outputs.date }}
          body: |
            ## ðŸ“¦ OpenClash è¦†å†™é…ç½®æ–‡ä»¶
            
            **ç”Ÿæˆæ—¶é—´**: ${{ steps.date.outputs.date }}
            
            ### ðŸ“ åŒ…å«çš„å†…å®¹
            
            - âœ… ç²¾ç®€åŽçš„ YAML é…ç½®æ–‡ä»¶ (`processed_configs/`)
            - âœ… OpenClash .conf è¦†å†™æ–‡ä»¶ (`output/`)
            - âœ… æ–‡ä»¶æ ¡éªŒå’Œ (`SHA256SUMS`)
            
            ### ðŸŽ¯ é…ç½®ç±»åž‹
            
            æ¯ä¸ªä¸Šæ¸¸é…ç½®éƒ½ç”Ÿæˆäº† 3 ç§å˜ä½“ï¼š
            - **æ ‡å‡†ç‰ˆ** (æ–‡ä»¶å.conf) - ä¸»è·¯ç”±ä½¿ç”¨
            - **æ—è·¯ç”±ç‰ˆ** (æ–‡ä»¶å-bypass_router.conf) - æ—è·¯ç”±ä½¿ç”¨  
            - **Smart ç‰ˆ** (æ–‡ä»¶å-smart.conf) - Smart æ™ºèƒ½æ¨¡å¼
            
            ### ðŸš€ å¿«é€Ÿå¼€å§‹
            
            1. é€‰æ‹©å¯¹åº”çš„ .conf æ–‡ä»¶
            2. å¤åˆ¶ Raw é“¾æŽ¥
            3. åœ¨ OpenClash ä¸­æ·»åŠ è¦†å†™æ¨¡å—
            4. è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼ˆæ ¹æ®æ–‡ä»¶ä¸­çš„è¯´æ˜Žï¼‰
            5. åº”ç”¨é…ç½®
            
            ### ðŸ“Š ç»Ÿè®¡ä¿¡æ¯
            
            - å¤„ç†çš„ YAML æ–‡ä»¶: $(ls processed_configs/*.yaml 2>/dev/null | wc -l)
            - ç”Ÿæˆçš„ .conf æ–‡ä»¶: $(ls output/*.conf 2>/dev/null | wc -l)
            
            ### ðŸ”— ç›¸å…³é“¾æŽ¥
            
            - [ä¸Šæ¸¸é¡¹ç›®](https://github.com/HenryChiao/mihomo_yamls)
            - [ä½¿ç”¨æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/README.md)
            
          files: |
            output/*.conf
            output/SHA256SUMS
            output/README.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add processed_configs/ output/
          
          git commit -m "ðŸ¤– Auto-build: ${{ steps.date.outputs.date }}" || echo "No changes to commit"
          
          git push
