name: Build OpenClash Overwrites

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # æ¯å¤©6ç‚¹è‡ªåŠ¨æ›´æ–°
  push:
    branches: [main]
    paths:
      - 'cleaner_config/**'
      - 'templates/**'
      - 'src/**'
      - '.github/workflows/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install pyyaml jinja2

      - name: Fetch External Configs
        run: |
          mkdir -p raw_configs/external
          git clone --depth=1 https://github.com/HenryChiao/mihomo_yamls.git /tmp/upstream
          
          # å¤åˆ¶ General_Config å’Œ Smart_Mode
          for dir in General_Config Smart_Mode; do
            if [ -d "/tmp/upstream/THEYAMLS/$dir" ]; then
              cp -r "/tmp/upstream/THEYAMLS/$dir" raw_configs/external/
              echo "ğŸ“¥ å·²å¤åˆ¶: $dir"
            fi
          done

      - name: Copy Local Configs
        run: |
          mkdir -p raw_configs/local
          if [ -d "cleaner_config" ]; then
            cp -r cleaner_config/* raw_configs/local/ 2>/dev/null || true
            echo "ğŸ“‚ å·²å¤åˆ¶æœ¬åœ°é…ç½®"
          fi

      - name: Strip YAML Configs
        run: |
          mkdir -p processed_configs/external processed_configs/local
          
          python src/yaml_stripper.py \
            --input raw_configs/external \
            --output processed_configs/external \
            --recursive
            
          python src/yaml_stripper.py \
            --input raw_configs/local \
            --output processed_configs/local \
            --recursive

      - name: Generate Overwrite Files
        run: |
          mkdir -p output/overwrites
          
          REPO_URL="https://raw.githubusercontent.com/${{ github.repository }}/main"
          
          # ç”Ÿæˆå¤–éƒ¨é…ç½®è¦†å†™
          python src/overwrite_generator.py \
            --input processed_configs/external \
            --output output/overwrites \
            --types main bypass smart \
            --repo-url "$REPO_URL" \
            --source external \
            -v
          
          # ç”Ÿæˆæœ¬åœ°é…ç½®è¦†å†™
          python src/overwrite_generator.py \
            --input processed_configs/local \
            --output output/overwrites \
            --types main bypass smart \
            --repo-url "$REPO_URL" \
            --source local \
            -v

      - name: Generate Documentation
        run: |
          python src/generate_index.py --output output/

      - name: Commit and Release
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add processed_configs/ output/
          git diff --staged --quiet || git commit -m "ğŸ¤– Auto-build: $(date +'%Y-%m-%d %H:%M')"
          git push

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v$(date +'%Y%m%d-%H%M%S')
          name: OpenClash Overwrites $(date +'%Y-%m-%d')
          body_path: output/RELEASE_NOTES.md
          files: |
            output/overwrites/*.conf
            output/overwrites/SHA256SUMS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
