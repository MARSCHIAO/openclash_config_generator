name: Build OpenClash Overwrites

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'
  push:
    branches: [main]
    paths:
      - 'cleaner_config/**'
      - 'templates/**'
      - 'src/**'
      - '.github/workflows/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyyaml jinja2
          sudo apt-get update && sudo apt-get install -y tree
      
      # ========== å¤–éƒ¨é…ç½® ==========
      - name: Fetch External Configs
        run: |
          echo "ðŸ“¥ Fetching external configs..."
          mkdir -p raw_configs/external
          
          git clone --depth=1 https://github.com/HenryChiao/mihomo_yamls.git /tmp/upstream
          
          # å¤åˆ¶å®Œæ•´çš„ç›®å½•ç»“æž„ï¼ˆä¿æŒä½œè€…å­ç›®å½•ï¼‰
          for dir in General_Config Smart_Mode; do
            if [ -d "/tmp/upstream/THEYAMLS/$dir" ]; then
              # ä¿æŒå®Œæ•´çš„ç›®å½•å±‚çº§ï¼ŒåŒ…æ‹¬ä½œè€…å­ç›®å½•
              cp -r "/tmp/upstream/THEYAMLS/$dir" raw_configs/external/
              echo "âœ… Copied: $dir (with subdirectories)"
            else
              echo "âš ï¸  Directory not found: $dir"
            fi
          done
          
          # æ˜¾ç¤ºå®Œæ•´ç»“æž„ï¼ˆåŒ…æ‹¬å­ç›®å½•ï¼‰
          echo "ðŸ“ External structure:"
          tree -L 3 raw_configs/external/ || find raw_configs/external -type d | head -20
      
      - name: Validate External Configs
        run: |
          if [ ! -d "raw_configs/external" ]; then
            echo "âŒ External configs directory not found"
            exit 1
          fi
          
          yaml_count=$(find raw_configs/external -name "*.yaml" -o -name "*.yml" | wc -l)
          echo "âœ… Found $yaml_count YAML files"
          
          if [ "$yaml_count" -eq 0 ]; then
            echo "âš ï¸  No YAML files found in external configs"
            exit 1
          fi
      
      - name: Process External YAMLs
        run: |
          mkdir -p processed_configs/external
          
          # å¦‚æžœæœ‰ yaml_processor.py å°±ä½¿ç”¨å®ƒ
          if [ -f "src/yaml_processor.py" ]; then
            python src/yaml_processor.py \
              --input raw_configs/external \
              --output processed_configs/external \
              --recursive
          else
            # å¦åˆ™ç›´æŽ¥å¤åˆ¶
            echo "â„¹ï¸  yaml_processor.py not found, copying files directly"
            cp -r raw_configs/external/* processed_configs/external/
          fi
      
      - name: Generate External Overwrites
        run: |
          mkdir -p overwrite
          
          python src/overwrite_generator.py \
            --input processed_configs/external \
            --output overwrite \
            --repo-url "https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}" \
            --source external \
            --verbose
      
      # ========== æœ¬åœ°é…ç½® ==========
      - name: Check Local Configs
        id: check_local
        run: |
          if [ -d "cleaner_config" ] && [ "$(ls -A cleaner_config 2>/dev/null)" ]; then
            echo "has_local=true" >> $GITHUB_OUTPUT
            echo "âœ… Local configs found"
          else
            echo "has_local=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No local configs"
          fi
      
      - name: Process Local Configs
        if: steps.check_local.outputs.has_local == 'true'
        run: |
          mkdir -p raw_configs/local/cleaner_config processed_configs/local/cleaner_config
          
          # å¤åˆ¶æœ¬åœ°é…ç½®åˆ°ä¸­é—´ç›®å½•ï¼Œä¿æŒ cleaner_config ç›®å½•å
          cp -r cleaner_config/* raw_configs/local/cleaner_config/
          
          # å¤„ç†
          if [ -f "src/yaml_processor.py" ]; then
            python src/yaml_processor.py \
              --input raw_configs/local \
              --output processed_configs/local \
              --recursive
          else
            cp -r raw_configs/local/* processed_configs/local/
          fi
          
          # ç”Ÿæˆè¦†å†™ï¼ˆè¾“å‡ºä¼šè‡ªåŠ¨åˆ›å»º overwrite/cleaner_configï¼‰
          python src/overwrite_generator.py \
            --input processed_configs/local \
            --output overwrite \
            --repo-url "https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}" \
            --source local \
            --verbose
          
          # éªŒè¯è¾“å‡ºç›®å½•
          if [ -d "overwrite/cleaner_config" ]; then
            conf_count=$(find overwrite/cleaner_config -name "*.conf" | wc -l)
            echo "âœ… cleaner_config directory created with $conf_count files"
          else
            echo "âŒ cleaner_config directory not created!"
            exit 1
          fi
      
      # ========== ç”Ÿæˆæ€» README ==========
      - name: Generate Main README
        run: |
          cat > overwrite/README.md << 'EOF'
          # OpenClash è¦†å†™é…ç½®åº“
          
          æœ¬ç›®å½•æŒ‰æ¥æºå’Œä½œè€…åˆ†ç±»å­˜æ”¾è‡ªåŠ¨ç”Ÿæˆçš„è¦†å†™é…ç½®æ–‡ä»¶ã€‚
          
          ## ðŸ“‚ ç›®å½•ç»“æž„
          
          ```
          overwrite/
          â”œâ”€â”€ General_Config/          # é€šç”¨é…ç½®
          â”‚   â”œâ”€â”€ Author1/             # ä½œè€…1çš„é…ç½®
          â”‚   â”‚   â”œâ”€â”€ README.md
          â”‚   â”‚   â””â”€â”€ Overwrite-*.conf (9 variants)
          â”‚   â”œâ”€â”€ Author2/             # ä½œè€…2çš„é…ç½®
          â”‚   â”‚   â”œâ”€â”€ README.md
          â”‚   â”‚   â””â”€â”€ Overwrite-*.conf (9 variants)
          â”‚   â””â”€â”€ ...
          â”œâ”€â”€ Smart_Mode/              # Smart æ™ºèƒ½æ¨¡å¼
          â”‚   â”œâ”€â”€ Author1/
          â”‚   â”‚   â”œâ”€â”€ README.md
          â”‚   â”‚   â””â”€â”€ Overwrite-*.conf (9 variants)
          â”‚   â”œâ”€â”€ Author2/
          â”‚   â”‚   â”œâ”€â”€ README.md
          â”‚   â”‚   â””â”€â”€ Overwrite-*.conf (9 variants)
          â”‚   â””â”€â”€ ...
          â””â”€â”€ cleaner_config/          # æœ¬åœ°è‡ªå®šä¹‰é…ç½®
              â”œâ”€â”€ README.md
              â””â”€â”€ Overwrite-*.conf (9 variants)
          ```
          
          ## ðŸš€ å¿«é€Ÿä½¿ç”¨
          
          1. **é€‰æ‹©é…ç½®ç±»åž‹**
             - `General_Config/` - é€šç”¨é…ç½®ï¼Œé€‚åˆæ—¥å¸¸ä½¿ç”¨
             - `Smart_Mode/` - æ™ºèƒ½æ¨¡å¼ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹
             - `cleaner_config/` - æœ¬åœ°è‡ªå®šä¹‰é…ç½®
          
          2. **é€‰æ‹©ä½œè€…/ç»´æŠ¤è€…**
             - è¿›å…¥å¯¹åº”çš„ä½œè€…å­ç›®å½•
             - æŸ¥çœ‹è¯¥ç›®å½•çš„ README.md äº†è§£é…ç½®è¯¦æƒ…
          
          3. **é€‰æ‹©é…ç½®å˜ä½“**
             - æ ¹æ®ä½ çš„ç½‘ç»œçŽ¯å¢ƒé€‰æ‹©åˆé€‚çš„å˜ä½“ï¼ˆæ ‡å‡†/Smart/æ—è·¯ç”±/LGBM/IPv6ï¼‰
          
          4. **åº”ç”¨é…ç½®**
             - åœ¨ OpenClash ä¸­æ·»åŠ è¦†å†™é…ç½®
             - è®¾ç½®å¿…è¦çš„çŽ¯å¢ƒå˜é‡
          
          ## ðŸ“ é…ç½®å˜ä½“è¯´æ˜Ž
          
          æ¯ä¸ªåŽŸå§‹ YAML ç”Ÿæˆ 9 ç§é…ç½®å˜ä½“ï¼š
          
          | åŽç¼€ | æ¨¡å¼ | IPv6 | LGBM | ç‰¹æ®Šè¦æ±‚ | å…¸åž‹ä½¿ç”¨åœºæ™¯ |
          |------|------|------|------|----------|-------------|
          | æ—  | æ ‡å‡† | âœ… | âŒ | æ—  | ä¸»è·¯ç”±ï¼Œæ”¯æŒ IPv6 |
          | `-noipv6` | æ ‡å‡† | âŒ | âŒ | æ—  | ä¸»è·¯ç”±ï¼Œçº¯ IPv4 ç½‘ç»œ |
          | `-bypass` | æ ‡å‡† | âŒ | âŒ | **éœ€ EN_DNS** | **æ—è·¯ç”±æ¨¡å¼** |
          | `-smart` | Smart | âœ… | âŒ | æ—  | æ™ºèƒ½é€‰èŠ‚ç‚¹ï¼Œæ”¯æŒ IPv6 |
          | `-smart-noipv6` | Smart | âŒ | âŒ | æ—  | æ™ºèƒ½é€‰èŠ‚ç‚¹ï¼Œçº¯ IPv4 |
          | `-smart-LGBM` | Smart | âœ… | âœ… | æ—  | æ™ºèƒ½ + AI ä¼˜åŒ– |
          | `-smart-noipv6-LGBM` | Smart | âŒ | âœ… | æ—  | æ™ºèƒ½ + AIï¼Œçº¯ IPv4 |
          | `-smart-bypass` | Smart | âŒ | âŒ | **éœ€ EN_DNS** | **æ™ºèƒ½æ—è·¯ç”±** |
          | `-smart-bypass-LGBM` | Smart | âŒ | âœ… | **éœ€ EN_DNS** | **æ™ºèƒ½æ—è·¯ç”± + AI** |
          
          ## ðŸ”§ çŽ¯å¢ƒå˜é‡è®¾ç½®
          
          ### åŸºç¡€å˜é‡ï¼ˆæ‰€æœ‰é…ç½®å¿…éœ€ï¼‰
          
          ```bash
          # å•ä¸ªè®¢é˜…
          EN_KEY=https://your-subscription-url
          
          # å¤šä¸ªè®¢é˜…ï¼ˆä½¿ç”¨åˆ†å·åˆ†éš”ï¼‰
          EN_KEY1=https://subscription1;EN_KEY2=https://subscription2
          ```
          
          ### æ—è·¯ç”±ä¸“ç”¨å˜é‡
          
          ä½¿ç”¨ `-bypass` ç³»åˆ—é…ç½®æ—¶å¿…é¡»è®¾ç½®ï¼š
          
          ```bash
          EN_DNS=223.5.5.5,114.114.114.114
          ```
          
          ### åœ¨ OpenClash ä¸­è®¾ç½®çŽ¯å¢ƒå˜é‡
          
          1. æ‰“å¼€ OpenClash æ’ä»¶é…ç½®é¡µé¢
          2. æ‰¾åˆ°ã€Œè¦†å†™è®¾ç½®ã€â†’ã€ŒçŽ¯å¢ƒå˜é‡ã€
          3. æ·»åŠ ä¸Šè¿°å¯¹åº”çš„å˜é‡
          4. ä¿å­˜å¹¶åº”ç”¨é…ç½®
          
          ## â° è‡ªåŠ¨æ›´æ–°
          
          - **å¤–éƒ¨é…ç½®**: æ¯æ—¥ 06:00 UTC è‡ªåŠ¨åŒæ­¥ HenryChiao ä»“åº“
          - **æœ¬åœ°é…ç½®**: æŽ¨é€åˆ° `cleaner_config/` æ—¶è‡ªåŠ¨é‡æ–°ç”Ÿæˆ
          - **ç»“æž„ä¿æŒ**: å®Œæ•´ä¿ç•™åŽŸå§‹ä»“åº“çš„ç›®å½•ç»“æž„å’Œåˆ†ç±»
          
          ## ðŸ“Š æž„å»ºä¿¡æ¯
          
          - æœ€åŽæ›´æ–°: REPLACE_WITH_TIMESTAMP
          - ä»“åº“: https://github.com/${{ github.repository }}
          - åˆ†æ”¯: ${{ github.ref_name }}
          
          EOF
          
          # æ›¿æ¢æ—¶é—´æˆ³
          sed -i "s/REPLACE_WITH_TIMESTAMP/$(date +'%Y-%m-%d %H:%M:%S UTC')/" overwrite/README.md
      
      - name: Validate Generated Files
        run: |
          conf_count=$(find overwrite -name "*.conf" | wc -l)
          readme_count=$(find overwrite -name "README.md" | wc -l)
          
          echo "âœ… Generated $conf_count .conf files"
          echo "âœ… Generated $readme_count README files"
          
          if [ "$conf_count" -eq 0 ]; then
            echo "âŒ No .conf files generated!"
            exit 1
          fi
      
      - name: Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add processed_configs/ overwrite/
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-build: $(date +'%Y-%m-%d %H:%M:%S')

          - Sync external configs from HenryChiao/mihomo_yamls
          - Process local configs from cleaner_config/
          - Generate categorized overwrites with READMEs
          
          Build info:
          - Workflow: ${{ github.workflow }}
          - Run: ${{ github.run_number }}
          - Trigger: ${{ github.event_name }}"
            
            git push
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
          conf_count=$(find overwrite -name "*.conf" 2>/dev/null | wc -l)
          readme_count=$(find overwrite -name "README.md" 2>/dev/null | wc -l)
          echo "- **Generated Configs**: $conf_count" >> $GITHUB_STEP_SUMMARY
          echo "- **README Files**: $readme_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Categories**: $(find overwrite -mindepth 1 -type d 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ Directory Structure (3 levels)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tree -L 3 overwrite/ 2>/dev/null || find overwrite -maxdepth 3 -type d | sort
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“‹ Category Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for category in overwrite/*/; do
            if [ -d "$category" ]; then
              cat_name=$(basename "$category")
              sub_count=$(find "$category" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
              conf_in_cat=$(find "$category" -name "*.conf" 2>/dev/null | wc -l)
              echo "- **$cat_name**: $sub_count subcategories, $conf_in_cat configs" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View Overwrites](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}/overwrite)" >> $GITHUB_STEP_SUMMARY
          echo "- [View Processed Configs](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}/processed_configs)" >> $GITHUB_STEP_SUMMARY
